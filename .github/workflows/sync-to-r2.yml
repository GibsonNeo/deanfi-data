name: Sync to Cloudflare R2

on:
  push:
    branches:
      - main
    paths:
      - '**/*.json'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-to-r2:
    runs-on: ubuntu-latest
    
    # Prevent concurrent syncs to avoid conflicts
    concurrency:
      group: r2-sync
      cancel-in-progress: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need 2 commits to detect changes
      
      - name: Detect changed JSON files
        id: changes
        run: |
          # Get list of changed JSON files (excluding cache directory)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger: sync all JSON files (except cache)
            echo "Manual trigger - syncing all JSON files (excluding cache/)"
            find . -name "*.json" -not -path "./.git/*" -not -path "./cache/*" > changed_files.txt
          else
            # Auto trigger: only sync changed files (except cache)
            git diff --name-only HEAD^ HEAD | grep '\.json$' | grep -v '^cache/' > changed_files.txt || true
          fi
          
          # Count files
          FILE_COUNT=$(wc -l < changed_files.txt)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          # Display files that will be synced
          if [ $FILE_COUNT -gt 0 ]; then
            echo "Files to sync to R2 (cache/ excluded):"
            cat changed_files.txt
          else
            echo "No JSON files changed in this commit (or only cache/ files changed)"
          fi
      
      - name: Setup Node.js
        if: steps.changes.outputs.file_count > 0
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        if: steps.changes.outputs.file_count > 0
        run: npm install -g wrangler
      
      - name: Upload changed files to R2
        if: steps.changes.outputs.file_count > 0
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "üöÄ Starting R2 sync for ${{ steps.changes.outputs.file_count }} file(s) to bucket: $R2_BUCKET_NAME..."
          
          UPLOAD_COUNT=0
          FAIL_COUNT=0
          
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "üì§ Uploading: $file"
              
              # Upload to R2 maintaining directory structure
              if wrangler r2 object put "$R2_BUCKET_NAME/$file" --file="$file" --remote; then
                echo "‚úÖ Successfully uploaded: $file"
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              else
                echo "‚ùå Failed to upload: $file"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
            else
              echo "‚ö†Ô∏è  File not found (may have been deleted): $file"
            fi
          done < changed_files.txt
          
          echo ""
          echo "üìä Upload Summary:"
          echo "   Total files: ${{ steps.changes.outputs.file_count }}"
          echo "   Successful: $UPLOAD_COUNT"
          echo "   Failed: $FAIL_COUNT"
          
          if [ $FAIL_COUNT -gt 0 ]; then
            echo "‚ö†Ô∏è  Some uploads failed - check logs above"
            exit 1
          else
            echo "‚úÖ All files synced successfully to R2!"
          fi
      
      - name: No changes detected
        if: steps.changes.outputs.file_count == 0
        run: |
          echo "‚ÑπÔ∏è  No JSON files changed in this commit (or only cache/ files changed) - skipping R2 sync"
